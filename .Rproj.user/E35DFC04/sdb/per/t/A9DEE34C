{
    "collab_server" : "",
    "contents" : "# R code for the cleaning of the data, creation of additional variables, subsetting and lagging of variables\n# Author: Malte Berneaud\n# Date: 30.04.2016\n\n# Packages needed for the execution of this Rmd are listed in include.packages and checked against the installed packages on the machine executing the code. If they are not installed, they will be installed automatically.\ninclude.packages <- c(\"dplyr\", \"ggplot2\", \"stringr\", \"readxl\", \"DataCombine\", \"texreg\",\n                      \"stargazer\", \"MASS\", \"knitr\", \"rmarkdown\", \"xtable\")\nneeded.packages <- include.packages[!(include.packages %in% installed.packages()[, \"Package\"])]\nif(length(needed.packages)) install.packages(needed.packages, \n                                             repos = \"https://cran.uni-muenster.de/\")\n\nlapply(include.packages, library, character.only = TRUE)  # loading all packages at once\n\n# exporting package citations\nknitr::write_bib(include.packages, \"packages.bib\")\n\n\n# Loading data ------------------------------------------------------------\n\n# Sparkassen Board Membership data\nSparkassenBoard <- read_excel(\"../data/BankBoards_Bavaria_RImport.xlsx\",\n                              sheet = \"BoardComp\")\n## define variable class:\nSparkassenBoard$Incumbent <- as.character(SparkassenBoard$Incumbent)\n\n# Municipal Election data\nMayorElection <- read_excel(\"../data/MayorElectionData.xlsx\",\n                            sheet = \"Bgm_OB\")\n\n\n# Cleaning Sparkassen data set --------------------------------------------\n\n# renaming variables\noldnames <- c(\"^name$\", \"^political...employee$\", \"^governing...opposition$\", \"retired.1.yes.\",\n              \"Name_CountyMunicipality\", \"Type_CountyMunicipality\")\nnewnames <- c(\"NameCandidate1\", \"political_employee\", \"governing_opposition\", \"retired\",\n              \"NameMunicipality\", \"type_county_municipality\")\nfor (i in seq_along(oldnames)) {\n  names(SparkassenBoard) <- gsub(oldnames[i], newnames[i], names(SparkassenBoard))\n}\n\n# trimming whitespace:\nSparkassenBoard$NameMunicipality <- str_trim(SparkassenBoard$NameMunicipality)\nSparkassenBoard$NameCandidate1 <- str_trim(SparkassenBoard$NameCandidate1)\n\n# creating variable for top position\nSparkassenBoard$TopPosition <- 0\nSparkassenBoard$TopPosition[SparkassenBoard$chair != \"no\"] <- 1\nSparkassenBoard$TopPosition <- as.character(SparkassenBoard$TopPosition)\n\n# Create sub-dataframes\n## :unique banks\nSparkassenBoard_UniqueBanks <- unique(SparkassenBoard[ ,c(\"bank_ID\", \"bank_name\", \n                                                          \"federal_state\", \"city\", \n                                                          \"board_size\")])\n\n## :Top Positions only\nSparkassenBoard_TopPositions <- subset(SparkassenBoard, TopPosition == 1)\n\n\n# Cleaning municipality election data set ---------------------------------\n\n# removing newlines\nnames(MayorElection) <- str_replace_all(names(MayorElection), \"[\\r\\n]\" , \"\")  \n# removing punctuation\nnames(MayorElection) <- gsub(\"[[:punct:]]\", \"\", names(MayorElection))\n# removing whitespace\nnames(MayorElection) <- str_trim(names(MayorElection))\n# correcting \"Geschlecht\"\nnames(MayorElection) <- gsub(\"^Geschl\", \"Geschlecht\", names(MayorElection))\n\n# Changing label names\nnewnames <- c(\"IDMunicipality\",\"NameMunicipality\", \"ElectionDate\", \"RunOffNecessary\", \"ElectionType\", \"ProfPolitician\", \"NumberEligVoter\", \"NumberVoters\", \"InvalBallots\", \"ValBallots\", \"NameCandidate1\")\n\nnames(MayorElection)[1:11] <- newnames\n\nnames(MayorElection) <- gsub(\"gültigeStimmen 1\", \"VotesCandidate1\", names(MayorElection))\nnames(MayorElection) <- gsub(\"Stimmen für nicht genannte Bewerber zusammen\", \"VotesRest\", names(MayorElection))\n\n# removing empty column 85\nMayorElection[, 85] <- NULL\n\n# Cleaning of gender strings\nMayorElection$Geschlecht1 <- str_trim(MayorElection$Geschlecht1)\n\n# cleaning of party names\nMayorElection$MayorParty <- MayorElection$\"Wahlvorschlag 1\"\nMayorElection$MayorParty <- str_trim(MayorElection$MayorParty)\n# reduce party to main party only\nMayorElection$MayorParty <- sub(\"/.*\",\"\", MayorElection$MayorParty)\n\n\n\n# Cleaning the party names for bar plotting\nMayorElection$CleanParty <- NA\nfor(i in 1:nrow(MayorElection)) {\n  if(is.na(MayorElection$MayorParty[i])) {\n    next\n  }\n  if(grepl(\"CSU\", MayorElection$MayorParty[i])) {\n    MayorElection$CleanParty[i] <- \"CSU\"\n  }else if(grepl(\"SPD\", MayorElection$MayorParty[i])) {\n    MayorElection$CleanParty[i] <- \"SPD\"\n  } else {\n    MayorElection$CleanParty[i] <- \"Other\"\n  }\n}\n\n\n# Creating additional variables -------------------------------------------\n\n# Extracting Phd titles\nMayorElection$Phd <- NA\nMayorElection$Phd <- ifelse(grepl(\"Dr.\", MayorElection$NameCandidate1), 1, 0)\nMayorElection$NameCandidate1 <- gsub(\" Dr.\", \"\", MayorElection$NameCandidate1)\nMayorElection$NameCandidate1 <- gsub(\" jur.\", \"\", MayorElection$NameCandidate1)\n\n\n# creating the total number of terms for each mayor\ntally <- dplyr::tally(group_by(MayorElection, NameCandidate1))\nnames(tally)[2] <- \"TotalTerms\"\n#merging that back into the data frame\nMayorElection <- merge(MayorElection, tally)\n\n# Extracting years from the election date character string\nMayorElection$Year <- strtrim(MayorElection$ElectionDate, 4L)\nMayorElection$Year <- as.integer(MayorElection$Year)  ## coercing year variable to an integer\n\n# Dummy variable for contested elections\nMayorElection$Contested <- ifelse(nchar(MayorElection$`Name 2Nachname Titel Vorname`)>2, 1, 0)\n\n# Calculating votes shares from the data\nMayorElection$VoteShareWinner <-  (MayorElection$VotesCandidate1 / MayorElection$ValBallots) * 100\n\n\n# Merging data sets -------------------------------------------------------\n# Ordering the data by municipality\nMayorElection$IDMunicipality <- as.integer(MayorElection$IDMunicipality)\nMayorElection <- arrange(MayorElection, IDMunicipality, Year)\n\n\n##: variable for board membership\nMayorElection$SparkassenMember <- is.element(MayorElection$NameCandidate1, unique(SparkassenBoard$NameCandidate1))\n\n##: variable for board membership of incumbent\n#library(DataCombine) # I moved the loading of the library up in the initiatl code which checks whether all necessary packages are installed, installs missings and then load them (named: \"fetching_library\") (MB)\nMayorElection <- slide(MayorElection, Var = \"SparkassenMember\",\n                       NewVar = \"IncumbentSparkassenMember\")\n\n# Subsetting the data set (part 1) -------------------------------------------------\n\n# subsetting by election type; excluding run-off elections\nMayorElection <- subset(MayorElection, ElectionType != 3)\n\n# Subsetting to contested elections only\nMayorElection <- subset(MayorElection, Contested == 1)\n\n\n# creating dummy for retired mayors ---------------------------------------\n\n# creating a vector with the column numbers of all other candidate names\notherCandidateColumns <- grep(\"Name \", names(MayorElection))\n\n# cleaning the remaining candidate columns from \" Dr.\" and \" jur.\" strings\nfor(i in otherCandidateColumns) {\n  MayorElection[, i]<- gsub(\" Dr.\", \"\", MayorElection[, i])\n  MayorElection[, i]<- gsub(\" jur.\", \"\", MayorElection[, i])\n}\n\n# Excluding mayors who probably retired (JM)\n# This loop is quick and produces 7472 observations where the candidate did stand\n# for election again\nMayorElection <- slide(MayorElection, Var = \"NameCandidate1\",\n                       GroupVar = \"IDMunicipality\",\n                       NewVar = \"L.NameCandidate1\")\n# MayorElection$Retired <- 1\n# MayorElection$Retired[MayorElection$NameCandidate1 ==\n#                         MayorElection$L.NameCandidate1] <- 0\n# MayorElection$Retired[MayorElection$`Name 2Nachname Titel Vorname` ==\n#                         MayorElection$L.NameCandidate1] <- 0\n# MayorElection$Retired[MayorElection$`Name 3Nachname Titel Vorname` ==\n#                         MayorElection$L.NameCandidate1] <- 0\n# MayorElection$Retired[MayorElection$`Name 4Nachname Titel Vorname` ==\n#                         MayorElection$L.NameCandidate1] <- 0\n\n# excluding mayors who did not run again (likely because of retirement) (MBK)\n# This loop is rather hacky and therefore quite slow and produces 7491 elections\n# where a mayor stood for re-election\n\n# creating empty variable to be filled in next step\nMayorElection$StandAgain <- NA\n# Loop starts at 2nd observation because otherwise 0 would be returned for i-1,\n# which results in NA for the logical condition of the if structure\nfor(i in 2:nrow(MayorElection)) {\n  # Creating a vector with the names of all candidates which ran in it\n  allCandidates <- as.character(MayorElection[i, c(1, otherCandidateColumns)])\n  # Partially matching the name of the previous mayor among the names of all\n  # candidates of the current election, if it there's a match, 1 will be assigned to\n  # the StandAgain variable. If there is no match, 0 is assigned.\n  if(is.na(MayorElection$L.NameCandidate1[i])) {\n    next()\n  }\n  if(any(pmatch(MayorElection$L.NameCandidate1[i], allCandidates), na.rm = TRUE)) {\n    MayorElection$StandAgain[i] <- 1\n  } else {\n    MayorElection$StandAgain[i] <- 0\n  }\n}\n\n\n\n# creating lagged variables -----------------------------------------------\n## Lagged DV\n# creating lagged incumbency for the calculation of the re-election binary variable\n# MayorElection <- slide(MayorElection, Var = \"NameCandidate1\", TimeVar = \"ElectionDate\", NewVar = \"L.NameCandidate1\")\nMayorElection$Reelection <- ifelse(MayorElection$NameCandidate1 == MayorElection$L.NameCandidate1, 1, 0)\n\n# Lagging variables for analysis, lag of SparkassenMembership is already implemented above. Lag variable is called \"IncumbentSparkassenMember\"\nMayorElection <- slide(MayorElection, Var = \"Geschlecht1\", TimeVar = \"ElectionDate\", NewVar = \"L.Geschlecht1\")\nMayorElection <- slide(MayorElection, Var = \"VoteShareWinner\", TimeVar = \"ElectionDate\", NewVar = \"L.VoteShareWinner\")\n\n# Subsetting for years and excluding retired mayors -----------------------------------\nMayorElection <- subset(MayorElection, Year >= 2006)\n# MayorElection <- subset(MayorElection, Retired == 0)\nMayorElection2 <- subset(MayorElection, StandAgain == 1)\n\n\n",
    "created" : 1462814726938.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2321512410",
    "id" : "A9DEE34C",
    "lastKnownWriteTime" : 1463046970,
    "last_content_update" : 1463046970476,
    "path" : "~/Git/FinalProject/paper/standalone_R_code.R",
    "project_path" : "paper/standalone_R_code.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}